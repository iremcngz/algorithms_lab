import java.io.*;
import java.util.ArrayList;
import java.util.Map;
import java.util.Scanner;


/**
 * This class accomplishes Mission Firewall
 */
public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    /**
     * TODO: Open and read the input file while searching for threats
     * TODO: Write results to both; a new file name "scanLog.txt" and to the console
     *
     * @param filename the input file
     * @throws IOException the io exception
     */


    public static String turbo64(String in) {
        // Implement turbo64 algorithm given by the assignment instructions
        // TODO: YOUR CODE HERE

                long mod_turbo=4294967291L;
                long a=0;
                long b=1;
                long result=0l;
                for(char c:in.toCharArray()){

                    a= (a + (int) c)%mod_turbo;
                    b= (a + b)%mod_turbo;
                }

                result = b<<32;
                result= result | a;
                return Long.toHexString(result);

    }
    public void scanFile(String filename) throws IOException {
        // TODO: YOUR CODE HERE
        System.out.println("Started scanning...\n"+
        "--------------------------------------------------------------------------------");

        //// scanLog file creation
        try {
            File myObj = new File("scanLog.txt");
            if (myObj.createNewFile()) {
            } else {
              //  System.out.println("File already exists.");
            }
        } catch (IOException e) {
            System.out.println("An error occurred.");
            e.printStackTrace();
        }
        BufferedWriter writer = new BufferedWriter(new FileWriter("scanLog.txt"));

        File messageFile = new File(filename);
        Scanner br = new Scanner(new FileInputStream(messageFile), "UTF-8");
        String line = "";
        int lineNumber = 0;
        int threatNumber=0;
        while (br.hasNextLine()) {
            line = br.nextLine();
            lineNumber++;
            String hash=turbo64(line);
            if(malwareDB.get(hash)!=null){
                System.out.println("Detected malware!\n"+malwareDB.get(hash).toString()+
                        "\n--------------------------------------------------------------------------------");
                threatNumber++;
                writer.write(malwareDB.get(hash).getHash()+"@"+lineNumber+"\n");
            }


        }
        System.out.println("Scan complete! "+threatNumber +" threats are found and eliminated. Generating log file...");
        writer.close();

    }
}
